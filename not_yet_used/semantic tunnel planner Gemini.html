<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Tunnel Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f1ea; /* Light beige background */
        }
        /* Style for the flowchart-like connections */
        .connector {
            position: absolute;
            border-left: 2px solid #8d8d8d; /* Grey connector line */
            border-bottom: 2px solid #8d8d8d;
            border-radius: 0 0 0 5px;
        }
        .connector-vertical {
            position: absolute;
            border-left: 2px solid #8d8d8d; /* Grey connector line */
            width: 2px;
        }
        /* Basic animation for feedback */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .pulse-animation {
            animation: pulse 1.5s infinite;
        }
        /* Style for message box */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            transition: opacity 0.5s ease-in-out;
        }
        /* Style for disabled buttons */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Earthy tones for buttons */
        .btn-primary {
            background-color: #a0522d; /* Sienna */
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #8b4513; /* SaddleBrown */
        }
        .btn-secondary {
            background-color: #d2b48c; /* Tan */
            color: #3a3a3a;
        }
         .btn-secondary:hover:not(:disabled) {
            background-color: #bc9b72;
        }
         .btn-info {
            background-color: #6b8e23; /* OliveDrab */
            color: white;
         }
         .btn-info:hover:not(:disabled) {
             background-color: #556b2f; /* DarkOliveGreen */
         }
        /* Card styling */
        .card {
            background-color: #ffffff;
            border: 1px solid #dcdcdc; /* Gainsboro */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Task styling */
        .task {
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .task:hover:not(.task-completed):not(.task-locked) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .task-active {
            border-color: #a0522d; /* Sienna */
            box-shadow: 0 0 5px rgba(160, 82, 45, 0.5);
        }
        .task-completed {
            background-color: #e0f2e9; /* Light green */
            color: #555;
            cursor: default;
            border-style: dashed;
        }
         .task-locked {
            background-color: #f5f5f5; /* Lighter grey */
            color: #aaa;
            cursor: not-allowed;
            border-style: dotted;
        }
        /* Modal backdrop */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75); /* Darker backdrop */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50; /* Ensure modals are on top */
            padding: 1rem; /* Padding for smaller screens */
        }
        /* Modal content */
        .modal-content {
             background-color: white;
             border-radius: 0.5rem; /* 8px */
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
             padding: 1.5rem; /* 24px */
             max-width: 95%; /* Max width relative to screen */
             width: 600px; /* Default max width */
             max-height: 90vh; /* Limit height */
             overflow-y: auto; /* Allow scrolling if content overflows */
        }
        /* Close button for modals */
        .modal-close-button {
            position: absolute;
            top: 0.5rem; /* 8px */
            right: 0.5rem; /* 8px */
            background: none;
            border: none;
            font-size: 1.5rem; /* 24px */
            line-height: 1;
            color: #9ca3af; /* gray-400 */
            cursor: pointer;
        }
        .modal-close-button:hover {
            color: #374151; /* gray-700 */
        }

    </style>
</head>
<body class="bg-[#f4f1ea] text-[#3a3a3a] p-4 md:p-8">

    <div class="container mx-auto max-w-6xl">

        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-[#6b4f3a]">Semantic Tunnel Planner</h1>
            <p class="text-lg text-[#8b735b] mt-2">Learn the benefits of semantic project planning.</p>
             <button id="help-button" class="absolute top-0 right-0 mt-2 mr-2 px-3 py-1 rounded-lg btn-info text-xs sm:text-sm">How to Play</button>
        </header>

        <div id="message-box" class="hidden p-4 rounded-lg shadow-md text-white max-w-md mx-auto text-center">
            <p id="message-text"></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <div class="md:col-span-1 card rounded-lg p-4">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-[#a0522d]">Project Status</h2>
                <div class="space-y-3 text-sm">
                    <p><strong>Phase:</strong> <span id="current-phase">Planning</span></p>
                    <p><strong>Time Elapsed:</strong> <span id="time-elapsed">0</span> weeks</p>
                    <p><strong>Budget Remaining:</strong> £<span id="budget-remaining">5,000,000</span></p>
                    <p><strong>Overall Progress:</strong> <span id="overall-progress">0</span>%</p>
                    <p><strong>Project Goal:</strong> Build the Solway Firth Tunnel</p>
                     <button id="reset-button" class="w-full mt-4 px-4 py-2 rounded-lg btn-secondary text-sm">Reset Game</button>
                </div>
                <div id="ontology-info" class="mt-6 p-3 bg-[#f9f9f9] border border-[#dcdcdc] rounded-md text-xs">
                    <h3 class="font-semibold text-[#6b4f3a] mb-1">Semantic Insight:</h3>
                    <p id="ontology-text">Semantic planning uses ontologies (formal knowledge models) to define tasks, resources, and their relationships clearly. This helps anticipate dependencies.</p>
                </div>
            </div>

            <div class="md:col-span-2 card rounded-lg p-4 relative">
                 <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-[#a0522d]">Work Breakdown Structure (WBS)</h2>
                 <p class="text-xs text-gray-500 mb-4">Click on available tasks (solid borders) to view details and start them.</p>
                <div id="wbs-container" class="space-y-6 relative">
                    </div>
            </div>

        </div>

        <div id="task-modal" class="hidden modal-backdrop">
            <div class="modal-content relative">
                 <button class="modal-close-button" onclick="closeTaskModal()">&times;</button>
                <h3 id="modal-title" class="text-xl font-semibold mb-3 text-[#a0522d]">Task Details</h3>
                <p id="modal-description" class="mb-3 text-sm"></p>
                <p class="text-sm"><strong>Cost:</strong> £<span id="modal-cost"></span></p>
                <p class="text-sm"><strong>Duration:</strong> <span id="modal-duration"></span> weeks</p>
                <div id="modal-dependencies-info" class="mt-3 text-xs bg-yellow-100 border border-yellow-300 p-2 rounded">
                     <p><strong>Dependencies:</strong> <span id="modal-dependencies"></span></p>
                     <p id="modal-dependency-status" class="font-medium"></p>
                </div>
                 <div id="modal-semantic-insight" class="mt-3 text-xs bg-blue-100 border border-blue-300 p-2 rounded">
                    <p><strong>Semantic Insight:</strong> <span id="modal-insight-text"></span></p>
                </div>
                <div class="mt-5 flex justify-end space-x-3">
                    <button id="modal-start-button" class="px-4 py-2 rounded-lg btn-primary text-sm">Start Task</button>
                    <button id="modal-close-button" class="px-4 py-2 rounded-lg btn-secondary text-sm">Close</button>
                </div>
            </div>
        </div>

         <div id="event-modal" class="hidden modal-backdrop">
            <div class="modal-content relative">
                 <button class="modal-close-button" onclick="closeEventModal()">&times;</button>
                <h3 class="text-xl font-semibold mb-3 text-red-600">Project Event!</h3>
                <p id="event-description" class="mb-4 text-sm"></p>
                 <div id="event-semantic-insight" class="mb-4 text-xs bg-blue-100 border border-blue-300 p-2 rounded">
                     <p><strong>Semantic Insight:</strong> <span id="event-insight-text"></span></p>
                 </div>
                <div id="event-options" class="space-y-2">
                    </div>
                 <button id="event-close-button" class="hidden mt-4 px-4 py-2 rounded-lg btn-secondary text-sm w-full">Acknowledge</button>
            </div>
        </div>

         <div id="help-modal" class="hidden modal-backdrop">
            <div class="modal-content relative">
                <button class="modal-close-button" onclick="closeHelpModal()">&times;</button>
                <h3 class="text-xl font-semibold mb-4 text-[#6b8e23]">How to Play: Semantic Tunnel Planner</h3>
                <div class="space-y-3 text-sm">
                    <p><strong>Objective:</strong> Successfully complete the tunnel project by managing tasks, budget, and time, while learning about semantic project planning.</p>
                    <p><strong>Game Flow:</strong></p>
                    <ul class="list-disc list-inside ml-4 text-xs">
                        <li>Time advances automatically (1 week every few seconds).</li>
                        <li>The game progresses through Planning, Excavation, and Lining phases.</li>
                        <li>Complete all tasks in a phase to move to the next.</li>
                        <li>Complete all tasks in all phases to win!</li>
                        <li>Running out of budget (£) ends the game.</li>
                    </ul>
                     <p><strong>Interacting with Tasks (WBS Panel):</strong></p>
                     <ul class="list-disc list-inside ml-4 text-xs">
                        <li>Tasks are shown in the Work Breakdown Structure (WBS).</li>
                        <li><strong class="border border-gray-400 px-1 rounded">Available Task:</strong> Solid border. Click to view details.</li>
                         <li><strong class="border border-dotted border-gray-400 px-1 rounded text-gray-500">Locked Task:</strong> Dotted border. Dependencies (previous tasks) are not yet complete.</li>
                         <li><strong class="border border-dashed border-gray-400 px-1 rounded bg-green-100">Completed Task:</strong> Dashed border, green background.</li>
                         <li><strong class="border border-orange-600 px-1 rounded shadow-md">Active Task:</strong> Orange border, pulsing. This task is currently being worked on. Only one task can be active.</li>
                        <li>Click an available task to open its details modal. Review cost, duration, dependencies, and the **Semantic Insight**.</li>
                        <li>Click "Start Task" in the modal (if affordable and dependencies met) to begin work.</li>
                    </ul>
                     <p><strong>Project Status Panel:</strong></p>
                     <ul class="list-disc list-inside ml-4 text-xs">
                        <li>Shows current Phase, Time Elapsed, Budget Remaining, and Overall Progress %.</li>
                        <li>The "Semantic Insight" box gives context on how semantic concepts apply to the current phase.</li>
                        <li>Use the "Reset Game" button to start over.</li>
                    </ul>
                    <p><strong>Events:</strong></p>
                    <ul class="list-disc list-inside ml-4 text-xs">
                        <li>Random events may occur, pausing the game and presenting a challenge.</li>
                        <li>Read the description and the **Semantic Insight** (explaining how the model helps understand the situation).</li>
                        <li>Choose an option to resolve the event. Your choice will impact budget and time.</li>
                    </ul>
                    <p><strong>Semantic Planning?:</strong> The game highlights how defining tasks, resources, risks, and dependencies clearly (like in semantic models/ontologies) helps anticipate problems and make better decisions during events.</p>
                </div>
                <div class="mt-5 text-right">
                     <button onclick="closeHelpModal()" class="px-4 py-2 rounded-lg btn-secondary text-sm">Close</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Game State ---
        let gameState = {};
        let gameLoopInterval = null; // Variable to hold the interval ID

        const initialGameState = {
            currentPhase: 'Planning',
            timeElapsed: 0,
            budgetRemaining: 5000000, // 5 Million
            overallProgress: 0,
            tasks: {
                // --- Planning Phase ---
                'define_scope': {
                    id: 'define_scope', name: 'Define Project Scope', phase: 'Planning', cost: 50000, duration: 4, dependencies: [], completed: false, progressPercent: 10,
                    description: 'Clearly outline the objectives, deliverables, and boundaries of the tunnel project.',
                    semanticInsight: 'Uses BFO (Basic Formal Ontology) concepts like `Object` (Tunnel) and `Process` (Construction) for clarity.'
                },
                'initial_survey': {
                    id: 'initial_survey', name: 'Initial Site Survey', phase: 'Planning', cost: 150000, duration: 8, dependencies: ['define_scope'], completed: false, progressPercent: 10,
                    description: 'Conduct geological and environmental surveys of the proposed tunnel route under the Solway Firth.',
                    semanticInsight: 'Links `Site` (Spatial Region) to `GeologicalFormation` (Material Entity) using domain ontology terms.'
                },
                'risk_assessment': {
                    id: 'risk_assessment', name: 'Risk Assessment', phase: 'Planning', cost: 80000, duration: 6, dependencies: ['initial_survey'], completed: false, progressPercent: 10,
                    description: 'Identify potential risks (geological, environmental, logistical) and plan mitigation strategies.',
                    semanticInsight: 'Explicitly models `Risk` entities and their relationship to `Process` (e.g., Excavation) and `Material` (e.g., Unstable Soil).'
                },
                 'secure_funding': {
                    id: 'secure_funding', name: 'Secure Funding & Permits', phase: 'Planning', cost: 20000, duration: 12, dependencies: ['define_scope'], completed: false, progressPercent: 5, // Less progress %
                    description: 'Finalize project funding and obtain necessary construction permits.',
                    semanticInsight: 'Connects `Stakeholder` (e.g., Funding Body, Regulatory Agency) roles to project `Goal` and `Process`.'
                 },
                 // --- Excavation Phase ---
                 'setup_site': {
                    id: 'setup_site', name: 'Setup Construction Site', phase: 'Excavation', cost: 200000, duration: 6, dependencies: ['initial_survey', 'secure_funding'], completed: false, progressPercent: 5,
                    description: 'Establish site offices, storage areas, and access roads.',
                    semanticInsight: 'Defines `Site` as a `SpatialRegion` with specific ` continuant parts` like `Building` and `Road`.'
                 },
                'start_shaft_1': {
                    id: 'start_shaft_1', name: 'Start Access Shaft 1', phase: 'Excavation', cost: 500000, duration: 15, dependencies: ['setup_site', 'risk_assessment'], completed: false, progressPercent: 15,
                    description: 'Begin excavating the primary access shaft on one side of the Firth.',
                    semanticInsight: 'Models `Shaft` as a `TunnelPart` and `Excavation` as a `Process` requiring specific `Equipment` (Resource).'
                },
                'start_tunnel_boring': {
                    id: 'start_tunnel_boring', name: 'Start Tunnel Boring', phase: 'Excavation', cost: 1000000, duration: 50, dependencies: ['start_shaft_1'], completed: false, progressPercent: 25,
                    description: 'Deploy the Tunnel Boring Machine (TBM) and begin the main excavation.',
                    semanticInsight: '`TBM` is an `EngineeredSystem` (Resource) performing the `Boring` process, dependent on `GeologicalFormation` data.'
                },
                 // --- Lining Phase ---
                 'install_lining': {
                    id: 'install_lining', name: 'Install Tunnel Lining', phase: 'Lining', cost: 800000, duration: 40, dependencies: ['start_tunnel_boring'], completed: false, progressPercent: 20,
                    description: 'Install concrete segments to form the permanent tunnel lining as the TBM progresses.',
                    semanticInsight: '`LiningSegment` (Material Entity) installation is a `Process` dependent on the `Boring` process output.'
                 },
                 'final_checks': {
                    id: 'final_checks', name: 'Final Checks & Commissioning', phase: 'Lining', cost: 100000, duration: 10, dependencies: ['install_lining'], completed: false, progressPercent: 5,
                     description: 'Conduct final safety inspections and prepare the tunnel for operation.',
                    semanticInsight: 'Uses quality assurance `Process` definitions linked to `Tunnel` specifications.'
                 }
            },
            activeTask: null, // ID of the task currently being worked on
            events: [ // Potential random events
                {
                    id: 'event_geology', triggerPhase: 'Excavation', chance: 0.15, // 15% chance per week in Excavation
                    description: "Unexpectedly hard rock encountered during boring, slowing progress and potentially damaging the TBM.",
                    insight: "The initial survey's semantic model linked `GeologicalFormation` to `BoringRate`. While hard rock was a *known* risk, its *exact* location wasn't specified. The model helps assess impact quickly.",
                    options: [
                        { text: "Use contingency budget for tougher TBM cutters (-£100k, +4 weeks)", cost: 100000, time: 4, effect: 'mitigated' },
                        { text: "Try to bore through slowly (+8 weeks, risk of TBM damage)", cost: 0, time: 8, effect: 'risky_delay' }
                    ]
                },
                 {
                    id: 'event_stakeholder', triggerPhase: 'Planning', chance: 0.10, // 10% chance per week in Planning
                    description: "A local environmental group raises new concerns about the tunnel's impact, demanding additional studies.",
                    insight: "The semantic model includes `Stakeholder` (Environmental Group) and their `Concern` (Impact). This structure helps trace their concerns back to specific `Process` steps (e.g., Site Survey) and address them systematically.",
                    options: [
                        { text: "Commission extra environmental study (-£50k, +6 weeks)", cost: 50000, time: 6, effect: 'appeased' },
                        { text: "Proceed as planned, risking legal challenges (+2 weeks delay for initial response)", cost: 0, time: 2, effect: 'ignored_risk' }
                    ]
                },
                 {
                    id: 'event_supply_chain', triggerPhase: 'Lining', chance: 0.12, // 12% chance per week in Lining
                    description: "Delivery of crucial concrete lining segments is delayed due to unforeseen logistical issues.",
                    insight: "The ontology links `LiningSegment` (Material) to `Supplier` (Agent) and `Transport` (Process). This highlights the dependency chain. The model shows installing lining depends on segment availability.",
                     options: [
                        { text: "Pay for expedited shipping (-£75k, +1 week)", cost: 75000, time: 1, effect: 'fast_tracked' },
                        { text: "Wait for regular delivery (+5 weeks)", cost: 0, time: 5, effect: 'standard_delay' }
                    ]
                }
            ],
            completedPhases: []
        };

        // --- DOM Elements ---
        const phaseEl = document.getElementById('current-phase');
        const timeEl = document.getElementById('time-elapsed');
        const budgetEl = document.getElementById('budget-remaining');
        const progressEl = document.getElementById('overall-progress');
        const wbsContainer = document.getElementById('wbs-container');
        const ontologyTextEl = document.getElementById('ontology-text');
        const resetButton = document.getElementById('reset-button');
        const helpButton = document.getElementById('help-button'); // New

        const taskModal = document.getElementById('task-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        const modalCost = document.getElementById('modal-cost');
        const modalDuration = document.getElementById('modal-duration');
        const modalDependencies = document.getElementById('modal-dependencies');
        const modalDependencyStatus = document.getElementById('modal-dependency-status');
        const modalInsight = document.getElementById('modal-semantic-insight');
        const modalInsightText = document.getElementById('modal-insight-text');
        const modalStartButton = document.getElementById('modal-start-button');
        const modalCloseButton = document.getElementById('modal-close-button'); // Refers to the button inside the task modal

        const eventModal = document.getElementById('event-modal');
        const eventDescription = document.getElementById('event-description');
        const eventInsight = document.getElementById('event-semantic-insight');
        const eventInsightText = document.getElementById('event-insight-text');
        const eventOptionsContainer = document.getElementById('event-options');
        const eventCloseButton = document.getElementById('event-close-button'); // Refers to the button inside the event modal

        const helpModal = document.getElementById('help-modal'); // New

        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // --- Game Logic Functions ---

        function initGame() {
            gameState = JSON.parse(JSON.stringify(initialGameState)); // Deep copy
            gameState.activeTask = null;
            gameState.completedPhases = [];
            updateDisplay();
            renderWBS();
            startGameLoop(); // Start the game loop
            showMessage("Game Started! Welcome to Semantic Tunnel Planner.", "info");
        }

        function startGameLoop() {
            // Clear existing interval if any
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            // Start new interval
            gameLoopInterval = setInterval(advanceWeek, 2000); // Advance 1 week every 2 seconds
        }

        function pauseGameLoop() {
             if (gameLoopInterval) clearInterval(gameLoopInterval);
             gameLoopInterval = null; // Set to null to indicate paused state
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('en-GB');
        }

        function updateDisplay() {
            phaseEl.textContent = gameState.currentPhase;
            timeEl.textContent = gameState.timeElapsed;
            budgetEl.textContent = formatCurrency(gameState.budgetRemaining);
            progressEl.textContent = Math.round(gameState.overallProgress);
            updateOntologyInsight();
        }

        function updateOntologyInsight() {
             let insight = "Semantic planning helps structure complex projects.";
             switch(gameState.currentPhase) {
                 case 'Planning': insight = "During Planning, ontologies define scope, identify stakeholders (like `:FundingBody`), and link surveys (`:SiteSurvey`) to potential risks (`:GeologicalRisk`)."; break;
                 case 'Excavation': insight = "In Excavation, the model connects `:Equipment` (TBM) to `:Process` (Boring) and `:Material` (Soil Type), clarifying resource needs and dependencies."; break;
                 case 'Lining': insight = "For Lining, semantics track dependencies between `:Boring` progress and `:LiningSegment` installation, highlighting supply chain links (`:Supplier`, `:Transport`)."; break;
                 case 'Completed': insight = "Project Completed! The semantic structure provided clarity and robustness throughout, aiding decision-making during unforeseen events."; break;
                 case 'Failed': insight = "Project Failed. Better semantic modeling of risks and dependencies might have prevented this outcome."; break;
             }
             ontologyTextEl.textContent = insight;
        }

        function renderWBS() {
            wbsContainer.innerHTML = ''; // Clear previous WBS
            const phases = ['Planning', 'Excavation', 'Lining'];
            let yOffset = 0;

            phases.forEach((phase, phaseIndex) => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'mb-6';
                const phaseTitle = document.createElement('h3');
                phaseTitle.className = `text-lg font-semibold mb-3 text-[#6b4f3a] ${gameState.completedPhases.includes(phase) ? 'line-through' : ''}`;
                phaseTitle.textContent = phase;
                phaseDiv.appendChild(phaseTitle);

                const taskGrid = document.createElement('div');
                taskGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 relative';
                phaseDiv.appendChild(taskGrid);

                let taskElements = [];

                Object.values(gameState.tasks).filter(task => task.phase === phase).forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.id = `task-${task.id}`;
                    taskEl.dataset.taskId = task.id;
                    taskEl.className = 'task p-3 rounded-md text-sm shadow';

                    const dependenciesMet = checkDependencies(task.id);

                    if (task.completed) {
                        taskEl.classList.add('task-completed');
                    } else if (!dependenciesMet) {
                         taskEl.classList.add('task-locked');
                    } else if (gameState.activeTask === task.id) {
                        taskEl.classList.add('task-active', 'pulse-animation');
                    }

                    taskEl.innerHTML = `
                        <p class="font-medium">${task.name}</p>
                        <p class="text-xs text-gray-500">${task.duration} weeks / £${formatCurrency(task.cost)}</p>
                        ${task.completed ? '<p class="text-xs text-green-600 font-semibold">Completed</p>' : ''}
                         ${!dependenciesMet && !task.completed ? '<p class="text-xs text-red-500 font-semibold">Locked (Deps)</p>' : ''}
                         ${gameState.activeTask === task.id ? `<p class="text-xs text-[#a0522d] font-semibold">In Progress (${task.workDone || 0}/${task.duration})</p>` : ''}
                    `;

                    if (!task.completed && dependenciesMet) {
                        taskEl.onclick = () => openTaskModal(task.id);
                    } else {
                        taskEl.style.cursor = 'not-allowed';
                    }
                    taskGrid.appendChild(taskEl);
                    taskElements.push({ el: taskEl, task: task });
                });
                 wbsContainer.appendChild(phaseDiv);
            });
        }

        function checkDependencies(taskId) {
            const task = gameState.tasks[taskId];
            if (!task || task.dependencies.length === 0) return true;
            return task.dependencies.every(depId => gameState.tasks[depId]?.completed);
        }

        function openTaskModal(taskId) {
            const task = gameState.tasks[taskId];
            if (!task || task.completed || gameState.activeTask) {
                 if(gameState.activeTask) showMessage("Another task is already in progress.", "warning");
                return;
            }

            pauseGameLoop(); // Pause game while modal is open

            modalTitle.textContent = task.name;
            modalDescription.textContent = task.description;
            modalCost.textContent = formatCurrency(task.cost);
            modalDuration.textContent = task.duration;
            modalInsightText.textContent = task.semanticInsight;

            const deps = task.dependencies.map(id => gameState.tasks[id]?.name || 'Unknown Task').join(', ');
            modalDependencies.textContent = deps || 'None';

            const dependenciesMet = checkDependencies(taskId);
            modalDependencyStatus.textContent = dependenciesMet ? 'All dependencies met.' : 'Dependencies not yet met.';
            modalDependencyStatus.className = dependenciesMet ? 'text-green-600 font-medium' : 'text-red-600 font-medium';

            modalStartButton.disabled = !dependenciesMet || gameState.activeTask !== null;
            modalStartButton.onclick = () => startTask(taskId);

            taskModal.classList.remove('hidden');
        }

        function closeTaskModal() {
            taskModal.classList.add('hidden');
            startGameLoop(); // Resume game when modal is closed
        }

        function startTask(taskId) {
            const task = gameState.tasks[taskId];
            if (!task || task.completed || gameState.activeTask || !checkDependencies(taskId)) {
                showMessage("Cannot start task. Check dependencies or if another task is active.", "error");
                 startGameLoop(); // Resume loop if start fails
                return;
            }

            if (gameState.budgetRemaining < task.cost) {
                 showMessage(`Not enough budget (£${formatCurrency(task.cost)} required).`, "error");
                 closeTaskModal(); // Will resume loop
                 return;
            }

            gameState.budgetRemaining -= task.cost;
            gameState.activeTask = taskId;
            task.workDone = 0;
            // Don't close modal here, closeTaskModal() handles resuming the loop
            closeTaskModal();
            updateDisplay();
            renderWBS();
            showMessage(`Task "${task.name}" started.`, "info");
        }

        function advanceWeek() {
             if (!gameLoopInterval) return; // Don't advance if paused

            if (gameState.currentPhase === 'Completed' || gameState.currentPhase === 'Failed') {
                 pauseGameLoop();
                 return;
            }

            gameState.timeElapsed++;

            if (gameState.activeTask) {
                const task = gameState.tasks[gameState.activeTask];
                task.workDone++;
                if (task.workDone >= task.duration) {
                    completeTask(gameState.activeTask);
                }
            }

            triggerRandomEvent();
            updateDisplay();
            renderWBS();

            if (gameState.budgetRemaining < 0) {
                gameOver("Project Failed: Ran out of budget!");
            }
        }

        function completeTask(taskId) {
            const task = gameState.tasks[taskId];
            if (!task) return;

            task.completed = true;
            gameState.overallProgress += task.progressPercent;
            gameState.overallProgress = Math.min(100, gameState.overallProgress);
            const completedTaskName = task.name;
            gameState.activeTask = null;

            showMessage(`Task "${completedTaskName}" completed!`, "success");
            checkPhaseCompletion();

            if (Object.values(gameState.tasks).every(t => t.completed)) {
                gameWin();
            }

            updateDisplay();
            renderWBS();
        }

        function checkPhaseCompletion() {
            const currentPhaseTasks = Object.values(gameState.tasks).filter(t => t.phase === gameState.currentPhase);
            const allTasksInPhaseComplete = currentPhaseTasks.every(t => t.completed);

            if (allTasksInPhaseComplete && !gameState.completedPhases.includes(gameState.currentPhase)) {
                 gameState.completedPhases.push(gameState.currentPhase);
                 const phases = ['Planning', 'Excavation', 'Lining'];
                 const currentIndex = phases.indexOf(gameState.currentPhase);
                 if (currentIndex < phases.length - 1) {
                     gameState.currentPhase = phases[currentIndex + 1];
                      showMessage(`Phase "${phases[currentIndex]}" completed! Moving to ${gameState.currentPhase}.`, "info");
                 }
            }
        }

        function triggerRandomEvent() {
             // Only trigger if game is running and no modals are open
             if (gameLoopInterval && eventModal.classList.contains('hidden') && taskModal.classList.contains('hidden') && helpModal.classList.contains('hidden')) {
                 gameState.events.forEach(event => {
                     if (event.triggerPhase === gameState.currentPhase && Math.random() < event.chance) {
                         showEvent(event);
                     }
                 });
             }
        }

         function showEvent(eventData) {
             pauseGameLoop(); // Pause game for event

             eventDescription.textContent = eventData.description;
             eventInsightText.textContent = eventData.insight;
             eventOptionsContainer.innerHTML = '';

             if (eventData.options && eventData.options.length > 0) {
                 eventCloseButton.classList.add('hidden');
                 eventData.options.forEach((option, index) => {
                     const button = document.createElement('button');
                     button.className = 'w-full px-4 py-2 rounded-lg btn-primary text-sm text-left';
                     button.textContent = option.text;
                     button.onclick = () => resolveEvent(eventData.id, index);
                     eventOptionsContainer.appendChild(button);
                 });
             } else {
                 eventCloseButton.classList.remove('hidden');
                 eventCloseButton.onclick = closeEventModal;
             }

             eventModal.classList.remove('hidden');
             showMessage("Project Event Occurred!", "warning", false);
         }

        function resolveEvent(eventId, optionIndex) {
            const eventData = gameState.events.find(e => e.id === eventId);
            const chosenOption = eventData.options[optionIndex];

            gameState.budgetRemaining -= chosenOption.cost;
            gameState.timeElapsed += chosenOption.time;

            let message = `Event Resolved: Chose "${chosenOption.text}". `;
            message += `Cost: £${formatCurrency(chosenOption.cost)}, Time Penalty: ${chosenOption.time} weeks.`;
            showMessage(message, "info");

            closeEventModal(); // Will resume loop
        }

        function closeEventModal() {
            eventModal.classList.add('hidden');
            startGameLoop(); // Resume game
            updateDisplay();
        }

        // --- New Help Modal Functions ---
        function openHelpModal() {
            pauseGameLoop(); // Pause game while help is open
            helpModal.classList.remove('hidden');
        }

        function closeHelpModal() {
            helpModal.classList.add('hidden');
            // Only resume loop if game isn't already over
            if (gameState.currentPhase !== 'Completed' && gameState.currentPhase !== 'Failed') {
                 startGameLoop();
            }
        }
        // --- End New Help Modal Functions ---


        function gameOver(reason) {
             pauseGameLoop();
             gameState.currentPhase = 'Failed';
             showMessage(reason, "error", false);
             updateDisplay();
             renderWBS();
        }

        function gameWin() {
             pauseGameLoop();
             gameState.currentPhase = 'Completed';
             const finalMessage = `Project Completed Successfully! Time: ${gameState.timeElapsed} weeks, Budget Left: £${formatCurrency(gameState.budgetRemaining)}. The semantic approach helped manage complexity!`;
             showMessage(finalMessage, "success", false);
             updateDisplay();
             renderWBS();
        }

        function showMessage(text, type = 'info', autoHide = true) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-600', 'opacity-0');
            messageBox.classList.add('opacity-100'); // Ensure visible

            let bgColor = 'bg-blue-500'; // Default info
            if (type === 'success') bgColor = 'bg-green-500';
            else if (type === 'warning') bgColor = 'bg-yellow-500';
            else if (type === 'error') bgColor = 'bg-red-600';

            messageBox.classList.add(bgColor);

            if (messageBox.timeoutId) clearTimeout(messageBox.timeoutId);

            if (autoHide) {
                messageBox.timeoutId = setTimeout(() => {
                    messageBox.classList.replace('opacity-100', 'opacity-0');
                     setTimeout(() => messageBox.classList.add('hidden'), 500);
                }, 4000);
            }
        }


        // --- Event Listeners ---
        modalCloseButton.onclick = closeTaskModal; // Task modal close button
        resetButton.onclick = initGame;
        helpButton.onclick = openHelpModal; // New help button listener

        // Add listeners for the explicit close buttons on modals (using onclick in HTML for simplicity here)
        // Alternatively, add them here:
        // document.querySelector('#task-modal .modal-close-button').onclick = closeTaskModal;
        // document.querySelector('#event-modal .modal-close-button').onclick = closeEventModal;
        // document.querySelector('#help-modal .modal-close-button').onclick = closeHelpModal;


        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', initGame);

    </script>

</body>
</html>
